name: Phoenix_Zygisk_Fixed_Total
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Project Structure
        run: |
          mkdir -p jni
          mkdir -p phoenix_zip/zygisk
          
          # 1. Menulis main.cpp (Fixed cheat_logic error)
          cat <<EOF > jni/main.cpp
          #include <jni.h>
          #include <thread>
          #include "zygisk.hpp"

          void cheat_loop() {
              while(true) {
                  std::this_thread::sleep_for(std::chrono::seconds(1));
              }
          }

          class MyModule : public zygisk::ModuleBase {
          public:
              void onLoad(zygisk::Api *api, JNIEnv *env) override {
                  std::thread(cheat_loop).detach();
              }
          };
          REGISTER_ZYGISK_MODULE(MyModule)
          EOF

          # 2. Menulis menu.cpp
          cat <<EOF > jni/menu.cpp
          // Menu Logic Placeholder
          EOF

          # 3. FIX 404 ERROR: Ambil header Zygisk dari link alternatif yang stabil
          curl -L https://raw.githubusercontent.com/topjohnwu/Magisk/364db31d683789a7f36979986348ef539828d0b2/native/jni/zygisk.hpp -o jni/zygisk.hpp

          # 4. Menulis Android.mk (Fix Unknown File Error)
          cat <<EOF > jni/Android.mk
          LOCAL_PATH := \$(call my-dir)
          include \$(CLEAR_VARS)
          LOCAL_MODULE    := arm64-v8a
          LOCAL_SRC_FILES := main.cpp menu.cpp
          LOCAL_LDLIBS    := -llog -landroid
          include \$(BUILD_SHARED_LIBRARY)
          EOF

          # 5. Menulis Application.mk (Fix APP_PLATFORM error)
          cat <<EOF > jni/Application.mk
          APP_ABI := arm64-v8a
          APP_PLATFORM := android-21
          APP_STL := c++_static
          EOF

          # 6. Menulis Identitas Modul
          cat <<EOF > phoenix_zip/module.prop
          id=phoenix_v3
          name=Phoenix Zygisk Fixed Total
          version=1.0
          author=Phoenix
          description=ESP & Auto Retri (Zero Error Build)
          EOF

      - name: Set up NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build SO (Fix Unknown File Error)
        run: |
          ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=jni/Android.mk

      - name: Packaging Module ZIP
        run: |
          cp libs/arm64-v8a/libarm64-v8a.so phoenix_zip/zygisk/arm64-v8a.so
          cd phoenix_zip
          zip -r ../Phoenix_Zygisk_Module.zip .

      - name: Upload Final Result
        uses: actions/upload-artifact@v4
        with:
          name: Phoenix_Installer_ZIP
          path: Phoenix_Zygisk_Module.zip
          
