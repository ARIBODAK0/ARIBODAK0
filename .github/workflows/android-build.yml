name: Auto Build APK

on:
  push:
    paths:
      - '*.tar.gz'
  workflow_dispatch:

env:
  PROJECT_DIR: HybridMindAI

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Archive
        run: |
          tar -xf *.tar.gz || { echo "Extract failed"; exit 1; }
          ls -la

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Auto-Fix Gradle Wrapper
        run: |
          cd $PROJECT_DIR
          mkdir -p gradle/wrapper
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading gradle-wrapper.jar..."
            curl -sL https://github.com/gradle/gradle/raw/v8.4.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
          fi
          chmod +x gradlew 2>/dev/null || true
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties

      - name: Auto-Fix Missing Resources
        run: |
          cd $PROJECT_DIR
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/values
                    # Create icon if missing
          if [ ! -f app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml ]; then
            echo "Creating ic_launcher_round.xml..."
            printf '<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@android:color/darker_gray"/>\n  <foreground android:drawable="@android:color/white"/>\n</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
          fi
          
          # Create ic_launcher.xml if missing
          if [ ! -f app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml ]; then
            echo "Creating ic_launcher.xml..."
            printf '<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@android:color/darker_gray"/>\n  <foreground android:drawable="@android:color/white"/>\n</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
          fi
          
          # Add colors if missing
          if [ ! -f app/src/main/res/values/colors.xml ]; then
            echo "Creating colors.xml..."
            printf '<?xml version="1.0" encoding="utf-8"?>\n<resources>\n  <color name="ic_launcher_background">#616161</color>\n  <color name="ic_launcher_foreground">#FFFFFF</color>\n</resources>' > app/src/main/res/values/colors.xml
          fi

      - name: Build APK (Auto-Retry)
        run: |
          cd $PROJECT_DIR
          
          echo "Starting build..."
          
          # First attempt
          if ./gradlew assembleDebug --no-daemon --stacktrace; then
            echo "Build successful!"
            exit 0
          fi
          
          # Second attempt with clean
          echo "First build failed, cleaning..."
          ./gradlew clean --no-daemon
          
          if ./gradlew assembleDebug --no-daemon --stacktrace; then
            echo "Build successful after clean!"
            exit 0
          fi
          
          echo "Build failed after 2 attempts"
          exit 1

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HybridMindAI-debug.apk
          path: ${{ env.PROJECT_DIR }}/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            ${{ env.PROJECT_DIR }}/build/
            ${{ env.PROJECT_DIR }}/app/build/
          retention-days: 7
