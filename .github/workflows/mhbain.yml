name: ‚úÖ RDP Max 60H (FINAL - Menggunakan Action Resmi)

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Masukkan Tailscale Auth Key (Wajib menggunakan Ephemeral Key)'
        required: true
        type: string

jobs:
  extended-rdp-session:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: ‚öôÔ∏è Configure OS & RDP for Best Performance
        shell: powershell
        run: |
          # Optimasi Windows Visual
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name "UserPreferencesMask" -Value ([byte[]](0x90, 0x12, 0x01, 0x80)) -Type Binary
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name "DragFullWindows" -Value 0
          
          # Configure RDP & Firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 2 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: üîê Create Ephemeral RDP User
        id: create_user
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Web
          $password = [System.Web.Security.Membership]::GeneratePassword(18, 4)
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          $username = "RDP_RUNNER" 
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          echo "RDP_USER_CREDENTIALS=User: $username | Password: $password" >> $env:GITHUB_ENV
          Write-Host "Pengguna $username berhasil dibuat."

      # üö® SOLUSI AKHIR UNTUK INSTALASI: Menggunakan GitHub Action resmi Tailscale
      - name: ‚¨áÔ∏è Install and Connect Tailscale
        id: tailscale-up
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.CLIENT_ID }} # Tidak digunakan, tetapi perlu didefinisikan untuk action
          oauth-secret: ${{ secrets.CLIENT_SECRET }} # Tidak digunakan
          authkey: ${{ github.event.inputs.tailscale_auth_key }}
          tags: tag:github-runner

      - name: üîó Get Tailscale IP
        shell: powershell
        run: |
          # Action resmi Tailscale membuat 'tailscale' tersedia di PATH secara otomatis
          $tsIP = & tailscale ip -4
          if (-not $tsIP) {
              Write-Error "Tailscale IP tidak ditetapkan oleh Action. Keluar."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Runner terhubung. IP: $tsIP"


      # üö® SOLUSI UNTUK KEEP-ALIVE: Memulai loop di Background (Tidak akan mati jika RDP ditutup)
      - name: ‚ú® Start Background Keep-Alive & Display
        shell: powershell
        run: |
          Write-Host "`n=========================================="
          Write-Host "=== RDP ACCESS KREDENSIAL ==="
          Write-Host "Alamat/IP Tailscale: $env:TAILSCALE_IP"
          Write-Host "$env:RDP_USER_CREDENTIALS"
          Write-Host "=========================================="
          
          # Skrip yang akan dijalankan di latar belakang (durasi 60 jam dalam detik)
          $BackgroundScript = {
              param($Duration)
              $StartTime = Get-Date
              while ((Get-Date).Subtract($StartTime).TotalSeconds -lt $Duration) {
                  Start-Sleep -Seconds 300 # Sleep 5 menit
              }
          }
          
          $totalDurationSeconds = 3600 * 60 # 60 jam
          
          # Mulai script di proses PowerShell baru yang terlepas (detached)
          Start-Process powershell.exe -WindowStyle Hidden -ArgumentList "-NoProfile", "-ExecutionPolicy Bypass", "-Command", "Start-Job -ScriptBlock { $BackgroundScript -Duration $totalDurationSeconds } | Wait-Job"
          
          Write-Host "Jaminan keep-alive telah dimulai di latar belakang. Anda sekarang dapat menutup jendela terminal ini."

      - name: ‚è≥ Final Holding Step
        run: sleep 4h

      # üö® CLEANUP: Kembali ke logika cleanup yang paling sederhana dan benar
      - name: üßπ Cleanup User
        if: always()
        shell: powershell
        run: |
          $username = "RDP_RUNNER" 
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Write-Host "Menghapus pengguna sementara $username..."
              Remove-LocalUser -Name $username 
              Write-Host "Pengguna $username telah dihapus."
          } else {
              Write-Host "Pengguna $username tidak ditemukan. Tidak ada yang dihapus."
          }
          
