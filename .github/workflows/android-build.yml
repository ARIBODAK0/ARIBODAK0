name: Build APK - Auto Fix

on:
  push:
    paths:
      - '*.tar.gz'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract project
        run: |
          tar -xf *.tar.gz
          ls -la

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Fix Gradle Wrapper
        run: |
          cd HybridMindAI
          mkdir -p gradle/wrapper
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            wget -q https://github.com/gradle/gradle/raw/v8.4.0/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
            echo "‚úÖ Downloaded gradle-wrapper.jar"
          fi
          chmod +x gradlew 2>/dev/null || true

      - name: Auto-Fix Missing Resources (Safe Mode)
        run: |
          cd HybridMindAI
          
          echo "üîç Checking for missing resources..."
          
          # Only create if NOT exists
          if [ ! -f app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml ]; then
            echo "‚ö†Ô∏è ic_launcher_round.xml missing - creating default..."
            mkdir -p app/src/main/res/mipmap-anydpi-v26            
            # Create SIMPLE adaptive icon (minimal)
            cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml << 'XMLEOF'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@android:color/darker_gray"/>
    <foreground android:drawable="@android:color/white"/>
</adaptive-icon>
XMLEOF
          else
            echo "‚úÖ ic_launcher_round.xml already exists"
          fi
          
          # Check colors.xml - only add missing colors
          if [ ! -f app/src/main/res/values/colors.xml ]; then
            echo "‚ö†Ô∏è colors.xml missing - creating..."
            mkdir -p app/src/main/res/values
            cat > app/src/main/res/values/colors.xml << 'COLOREOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_background">#616161</color>
    <color name="ic_launcher_foreground">#FFFFFF</color>
</resources>
COLOREOF
          else
            echo "‚úÖ colors.xml already exists"
            # Add missing colors if needed (append only)
            if ! grep -q "ic_launcher_background" app/src/main/res/values/colors.xml; then
              echo "‚ö†Ô∏è Adding missing launcher colors..."
              sed -i '/<\/resources>/i\    <color name="ic_launcher_background">#616161</color>\n    <color name="ic_launcher_foreground">#FFFFFF</color>' app/src/main/res/values/colors.xml
            fi
          fi
          
          echo "‚úÖ Resource check complete"

      - name: Create local.properties
        run: |
          cd HybridMindAI
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties

      - name: Build APK (with auto-retry)
        run: |
          cd HybridMindAI
          
          # Try build
          if ./gradlew assembleDebug --no-daemon; then
            echo "‚úÖ Build successful on first try!"
          else
            echo "‚ö†Ô∏è First build failed, trying clean build..."
            ./gradlew clean --no-daemon            ./gradlew assembleDebug --no-daemon --stacktrace
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug.apk
          path: HybridMindAI/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload Build Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            HybridMindAI/app/build/outputs/
            HybridMindAI/build/
