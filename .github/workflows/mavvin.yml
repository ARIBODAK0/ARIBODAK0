name: Phoenix_Zygisk_V4_Fixed
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Project Structure
        run: |
          mkdir -p jni
          mkdir -p phoenix_zip/zygisk
          
          # Membuat main.cpp
          cat <<EOF > jni/main.cpp
          #include <jni.h>
          #include <thread>
          #include "zygisk.hpp"
          void cheat() { while(true) { std::this_thread::sleep_for(std::chrono::seconds(1)); } }
          class MyMod : public zygisk::ModuleBase {
              void onLoad(zygisk::Api *api, JNIEnv *env) override { std::thread(cheat).detach(); }
          };
          REGISTER_ZYGISK_MODULE(MyMod)
          EOF

          # Download library zygisk agar tidak error file not found
          curl -L https://raw.githubusercontent.com/topjohnwu/Magisk/master/native/jni/zygisk.hpp -o jni/zygisk.hpp

          # Membuat instruksi build (Android.mk)
          cat <<EOF > jni/Android.mk
          LOCAL_PATH := \$(call my-dir)
          include \$(CLEAR_VARS)
          LOCAL_MODULE    := arm64-v8a
          LOCAL_SRC_FILES := main.cpp
          LOCAL_LDLIBS    := -llog -landroid
          include \$(BUILD_SHARED_LIBRARY)
          EOF

          # Membuat identitas modul Magisk
          cat <<EOF > phoenix_zip/module.prop
          id=phoenix_v3
          name=Phoenix Zygisk Fixed v4
          version=1.0
          author=Phoenix
          description=Modul ESP & Auto Retri (Build v4 Success)
          EOF

      - name: Set up NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build SO
        run: |
          cd jni
          ndk-build NDK_PROJECT_PATH=. APP_ABI=arm64-v8a

      - name: Packaging Module
        run: |
          # Pindahkan hasil kompilasi ke folder ZIP
          cp libs/arm64-v8a/libarm64-v8a.so phoenix_zip/zygisk/arm64-v8a.so
          cd phoenix_zip
          zip -r ../Phoenix_Zygisk_Module.zip .

      - name: Upload Final ZIP (Fixed Version)
        uses: actions/upload-artifact@v4
        with:
          name: Phoenix_Zygisk_Installer
          path: Phoenix_Zygisk_Module.zip
          
