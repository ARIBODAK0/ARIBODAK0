name: Phoenix_Zygisk_With_Menu
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Project Structure
        run: |
          mkdir -p jni
          mkdir -p phoenix_zip/zygisk
          
          # 1. Membuat menu.h (Definisi Menu)
          cat <<EOF > jni/menu.h
          #ifndef MENU_H
          #define MENU_H
          void DrawMenu();
          #endif
          EOF

          # 2. Membuat menu.cpp (Tampilan Menu Tanpa Login)
          cat <<EOF > jni/menu.cpp
          #include <jni.h>
          #include "menu.h"
          
          bool esp_line = false;
          bool auto_retri = false;

          void DrawMenu() {
              // Di sini abang bisa menambahkan UI ImGui nantinya
              // Untuk sekarang ini adalah placeholder fungsi menu
          }
          EOF

          # 3. Membuat main.cpp (Menghubungkan Menu & Cheat)
          cat <<EOF > jni/main.cpp
          #include <jni.h>
          #include <thread>
          #include "zygisk.hpp"
          #include "menu.h"

          void cheat_thread() {
              DrawMenu(); // Memanggil menu saat cheat aktif
              while(true) {
                  std::this_thread::sleep_for(std::chrono::milliseconds(100));
              }
          }

          class MyModule : public zygisk::ModuleBase {
          public:
              void onLoad(zygisk::Api *api, JNIEnv *env) override {
                  std::thread(cheat_thread).detach();
              }
          };
          REGISTER_ZYGISK_MODULE(MyModule)
          EOF

          # 4. FIX 404: Ambil library zygisk.hpp yang asli
          curl -L https://raw.githubusercontent.com/topjohnwu/Zygisk-Module-Sample/master/jni/zygisk.hpp -o jni/zygisk.hpp

          # 5. Membuat Android.mk (Menggabungkan semua file)
          cat <<EOF > jni/Android.mk
          LOCAL_PATH := \$(call my-dir)
          include \$(CLEAR_VARS)
          LOCAL_MODULE    := arm64-v8a
          LOCAL_SRC_FILES := main.cpp menu.cpp
          LOCAL_LDLIBS    := -llog -landroid
          include \$(BUILD_SHARED_LIBRARY)
          EOF

          # 6. Membuat Application.mk
          cat <<EOF > jni/Application.mk
          APP_ABI := arm64-v8a
          APP_PLATFORM := android-21
          APP_STL := c++_static
          EOF

          # 7. Membuat module.prop
          cat <<EOF > phoenix_zip/module.prop
          id=phoenix_v3_menu
          name=Phoenix V3 + Menu Melayang
          version=3.0
          author=Phoenix
          description=Modul Zygisk dengan Menu ESP & Auto Retri (No Login)
          EOF

      - name: Set up NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build SO
        run: |
          ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=jni/Android.mk

      - name: Packaging Module ZIP
        run: |
          cp libs/arm64-v8a/libarm64-v8a.so phoenix_zip/zygisk/arm64-v8a.so
          cd phoenix_zip
          zip -r ../PHOENIX_MENU_FINAL.zip .

      - name: Upload Final Result (v4)
        uses: actions/upload-artifact@v4
        with:
          name: Phoenix_Menu_Module
          path: PHOENIX_MENU_FINAL.zip
          
